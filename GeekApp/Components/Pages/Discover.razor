@page "/discover"
@using GeekApp.Shared.ApiModels
@inject IContentService ContentService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<Discover> Logger

<div class="min-vh-100 bg-tepapa-green text-white">
    <div class="container py-5">
        <h1 class="h2 fw-bold mb-4 orbitron">Discover Movies & TV Shows</h1>

        <!-- Filters -->
        <div class="mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Media Type</label>
                    <select class="form-select" @bind="MediaType" @bind:event="onchange">
                        <option value="movie">Movies</option>
                        <option value="tv">TV Shows</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="SortBy" @bind:event="onchange">
                        <option value="popularity.desc">Popularity</option>
                        <option value="vote_average.desc">Rating (High to Low)</option>
                        <option value="vote_count.desc">Most Voted</option>
                        <option value="primary_release_date.desc">Release Year (Newest)</option>
                        <option value="primary_release_date.asc">Release Year (Oldest)</option>
                        @if (MediaType == "movie")
                        {
                            <option value="revenue.desc">Revenue (High to Low)</option>
                        }
                        @if (MediaType == "tv")
                        {
                            <option value="first_air_date.desc">Air Date (Newest)</option>
                            <option value="first_air_date.asc">Air Date (Oldest)</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Release Year Range</label>
                    <div class="input-group">
                        <input type="number" class="form-control" placeholder="From" @bind="tempMinYear" min="1900" max="@DateTime.Now.Year" />
                        <input type="number" class="form-control" placeholder="To" @bind="tempMaxYear" min="1900" max="@DateTime.Now.Year" />
                        <button class="btn btn-light-blue" @onclick="ApplyYearRange">Apply</button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Genres</label>
                    <div class="genre-checkboxes" style="max-height: 150px; overflow-y: auto;">
                        @foreach (var genre in genres)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="genre-@genre.Id" checked="@selectedGenres.Contains(genre.Id)" @onchange="e => ToggleGenre(genre.Id, e.Value)" disabled="@(selectedGenres.Count >= 3 && !selectedGenres.Contains(genre.Id))" />
                                <label class="form-check-label" for="genre-@genre.Id">@genre.Name</label>
                            </div>
                        }
                    </div>
                    @if (selectedGenres.Count >= 3)
                    {
                        <small class="text-warning">Maximum 3 genres allowed.</small>
                    }
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-light-blue" @onclick="ForceRefresh">Refresh Results</button>
            </div>
        </div>

        <!-- Results -->
        @if (isLoading)
        {
            <div class="d-flex align-items-center justify-content-center">
                <div class="spinner-border text-light-blue" role="status"></div>
                <span class="ms-3 fs-5">Loading...</span>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="alert alert-danger shadow-sm" role="alert">
                <strong>Error:</strong> @errorMessage
            </div>
        }
        else if (displayedResults != null)
        {
            <h2 class="h3 fw-bold mb-4 orbitron">Discover Results</h2>
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4" id="results-container">
                @foreach (var result in displayedResults)
                {
                    <div class="col">
                        <a href="/@(result.MediaType ?? MediaType)/@result.Id" class="result-card bg-gray-800 rounded-3 shadow-sm text-center text-decoration-none">
                            <img src="@result.PosterPath" alt="@(result.Title ?? result.Name ?? "Unknown")" class="img-fluid rounded-top result-img" onerror="this.src='/images/errorimage.jpg'" />
                            <div class="p-3">
                                <p class="fw-medium text-white mb-1">@(result.Title ?? result.Name ?? "Unknown")</p>
                                <p class="text-sm text-gray-400 mb-0">@(MediaType == "movie" ? "Movie" : "TV Show") - @(result.ReleaseDate ?? result.FirstAirDate ?? "N/A")</p>
                            </div>
                        </a>
                    </div>
                }
            </div>

            <!-- Load More Button -->
            @if (hasMoreResults)
            {
                <div class="text-center mt-4">
                    <button class="btn btn-light-blue" @onclick="LoadMoreResults">Load More</button>
                </div>
            }
        }
    </div>
</div>

@code {
    private string mediaType = "movie";
    private string sortBy = "popularity.desc";
    private int? minYear;
    private int? maxYear;
    private int? tempMinYear;
    private int? tempMaxYear;
    private List<int> selectedGenres = new();
    private List<TmdbGenre> genres = new();
    private List<TmdbResult> displayedResults = new();
    private bool isLoading = true;
    private string errorMessage;
    private int currentPage = 1;
    private bool hasMoreResults = true;
    private const int MinVoteCount = 300;
    private string cacheVersion = Guid.NewGuid().ToString("N")[..8];

    private string MediaType
    {
        get => mediaType;
        set
        {
            if (mediaType != value)
            {
                mediaType = value;
                cacheVersion = Guid.NewGuid().ToString("N")[..8];
                ResetAndLoad();
            }
        }
    }

    private string SortBy
    {
        get => sortBy;
        set
        {
            if (sortBy != value)
            {
                sortBy = value;
                cacheVersion = Guid.NewGuid().ToString("N")[..8];
                ResetAndLoad();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        currentPage = 1;
        await LoadGenres();
        await LoadDiscoverResults();
    }

    private async Task ResetAndLoad()
    {
        displayedResults.Clear();
        currentPage = 1;
        hasMoreResults = true;
        await LoadGenres();
        await LoadDiscoverResults();
    }

    private async Task ApplyYearRange()
    {
        minYear = tempMinYear;
        maxYear = tempMaxYear;
        cacheVersion = Guid.NewGuid().ToString("N")[..8];
        displayedResults.Clear();
        currentPage = 1;
        hasMoreResults = true;
        await LoadDiscoverResults();
        UpdateUrl();
    }

    private async Task LoadMoreResults()
    {
        var scrollPosition = await JSRuntime.InvokeAsync<double>("getScrollPosition");
        currentPage++;
        await LoadDiscoverResults();
        await JSRuntime.InvokeVoidAsync("setScrollPosition", scrollPosition);
    }

    private async Task ForceRefresh()
    {
        cacheVersion = Guid.NewGuid().ToString("N")[..8];
        displayedResults.Clear();
        currentPage = 1;
        hasMoreResults = true;
        await LoadDiscoverResults();
    }

    private async Task LoadGenres()
    {
        try
        {
            isLoading = true;
            genres = await ContentService.GetGenresAsync(mediaType);
            selectedGenres = selectedGenres.Where(g => genres.Any(genre => genre.Id == g)).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load genres: {ex.Message}";
            Logger.LogError(ex, "Failed to load genres");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDiscoverResults()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            if (currentPage < 1) currentPage = 1;
            if (minYear.HasValue && maxYear.HasValue && minYear > maxYear)
                (minYear, maxYear) = (maxYear, minYear);
            if (selectedGenres.Count > 3)
                selectedGenres = selectedGenres.Take(3).ToList();

            int? minVoteCount = sortBy == "vote_average.desc" ? MinVoteCount : null;

            var validGenres = selectedGenres.Where(g => genres.Any(genre => genre.Id == g)).ToList();

            Logger.LogInformation($"Discover request: Type={mediaType}, Page={currentPage}, Sort={sortBy}, " +
                $"Years={minYear}-{maxYear}, Genres={string.Join(",", validGenres)}, VoteCount={minVoteCount}");

            var discoverResults = await ContentService.DiscoverAsync(
                mediaType,
                currentPage,
                sortBy,
                minYear,
                maxYear,
                validGenres.Any() ? validGenres : null,
                minVoteCount);

            hasMoreResults = currentPage < discoverResults.TotalPages;

            foreach (var result in discoverResults.Results)
            {
                result.MediaType = mediaType;
                if (string.IsNullOrEmpty(result.PosterPath))
                {
                    result.PosterPath = "/images/errorimage.jpg";
                }
            }

            if (currentPage == 1)
            {
                displayedResults = discoverResults.Results.ToList();
            }
            else
            {
                displayedResults.AddRange(discoverResults.Results);
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.BadRequest)
        {
            errorMessage = "Invalid request parameters. Please check your filters and try again.";
            Logger.LogError(ex, "Bad request in Discover");
            displayedResults = new List<TmdbResult>();
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            Logger.LogError(ex, "Error in Discover");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void UpdateUrl()
    {
        var url = $"/discover?mediaType={mediaType}&sortBy={sortBy}";
        if (minYear.HasValue) url += $"&minYear={minYear}";
        if (maxYear.HasValue) url += $"&maxYear={maxYear}";
        if (selectedGenres.Any()) url += $"&genres={string.Join(",", selectedGenres)}";
        Navigation.NavigateTo(url, forceLoad: false);
    }

    private async void ToggleGenre(int genreId, object checkedValue)
    {
        if ((bool)checkedValue)
        {
            if (!selectedGenres.Contains(genreId) && selectedGenres.Count < 3)
                selectedGenres.Add(genreId);
        }
        else
        {
            selectedGenres.Remove(genreId);
        }
        cacheVersion = Guid.NewGuid().ToString("N")[..8];
        displayedResults.Clear();
        currentPage = 1;
        hasMoreResults = true;
        await LoadDiscoverResults();
    }
}